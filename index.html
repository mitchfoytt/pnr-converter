<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Travel Tailor - PNR Converter</title>
  <link href="https://integrations.missiveapp.com/missive.css" rel="stylesheet">
  <script src="https://integrations.missiveapp.com/missive.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    body {
      background-color: #f5f6f7;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      padding: 24px;
    }
    .missive-integration {
      flex: none;
    }
    footer {
      flex-shrink: 0;
    }
    .container {
      background: white;
      border: 1px solid #d0d3d6;
      padding: 16px;
      border-radius: 6px;
      max-width: 100%;
    }
    @media (max-width: 600px) {
      .container {
        padding: 12px;
      }
    }
    textarea.input {
      width: 100%;
      border: 1px solid var(--base-color-neutral--300, #d0d3d6);
      background-color: var(--base-color-surface-default, #fff);
      color: inherit;
      font-size: 14px;
      padding: 12px;
      border-radius: 6px;
      resize: vertical;
      font-family: inherit;
    }
    .button {
      background-color: var(--base-color-brand--primary, #2266ed);
      color: var(--base-color-foreground-on-primary, white);
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      cursor: pointer;
    }
    .button:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(34, 102, 237, 0.3);
    }
    .button:hover {
      background-color: var(--base-color-brand--primary-dark, #1a50c1);
      color: var(--base-color-foreground-on-primary, white);
    }
    .button-async,
    .button-async:hover {
      background-color: var(--base-color-brand--primary, #2266ed) !important;
      color: var(--base-color-foreground-on-primary, white) !important;
    }
    .button-async--loading,
    .button-async--loading:hover {
      opacity: 1 !important;
      background-color: var(--base-color-brand--primary-dark, #1a50c1) !important;
      color: var(--base-color-foreground-on-primary, white) !important;
    }
    table {
      border-collapse: collapse;
      width: 880px;
      margin-top: 1em;
    }
    th, td {
      border: 1px solid #333;
      padding: 8px 10px;
      text-align: left;
      font-size: 12px;
    }
    th {
      background-color: #e6e8ea;
      color: #000;
      font-size: 12px;
      font-weight: bold;
      padding: 6px 8px;
      white-space: nowrap;
      line-height: 1.4;
    }
    td img {
      max-width: 100px;
      max-height: 35px;
      height: auto;
      display: block;
      margin: 0 auto;
      Vertical-align: middle;
      object-fit: contain;
    }
    td.logo-cell {
      width: 100px;
      text-align: center;
    }
    td .operated-by {
      font-size: 90% !important;
      color: #555 !important;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif !important;
      line-height: 1.4 !important;
      display: block !important;
    }
    .options-container {
      padding: 12px;
    }
    .options-container.collapsed > div {
      display: none;
    }
    @media (prefers-color-scheme: dark) {
      body {
        background-color: #1e1e1e;
        color: #ddd;
      }
      .container,
      .output-container {
        background-color: #2b2b2b;
        border-color: #444;
      }
      textarea.input {
        background-color: #333;
        color: #eee;
      }
      .button {
        background-color: #3a6ee8;
        color: white;
      }
      .button:hover {
        background-color: #2e59c5;
      }
      table {
        border-color: #555;
      }
      th {
        background-color: #2b2b2b;
        color: #ddd;
      }
      /* The following rules for td and td img are intentionally removed or commented out to prevent dark mode from overriding email table formatting:
      td {
        color: #ddd;
      }
      td img {
        filter: brightness(0.9);
      }
      */
      tr:nth-child(even) td {
        background-color: #262626;
      }
      tr:nth-child(odd) td {
        background-color: #1f1f1f;
      }
    }
    /* .options-container.collapsed rules removed (see above for new rules) */
    .options-container h4 {
      margin: 0;
      line-height: 1.4;
    }
    .browser-only {
      display: block;
    }
    .missive-integration iframe .browser-only {
      display: none !important;
    }
  </style>
</head>
<body>
<main style="flex: 1;">
  <div class="missive-integration">
    <div class="container">
      <div class="browser-header" style="display: none;">
        <h3 class="text-xlarge text-800">Travel Tailor - PNR Converter</h3>
      </div>
      <textarea id="pnrInput" class="input" rows="8" style="width: 100%; height: 200px;" placeholder="Paste PNR here"></textarea>
      <div style="display: flex; gap: 12px; margin-top: 1em;">
        <button class="button button-async" id="submitBtn" onclick="fetchFlightData()" data-loading="Converting…" data-state="default">
          <span><span class="button-async-label">Convert PNR</span></span>
          <div class="loading-icon">
            <i class="icon icon-circle" style="width: 24px; height: 24px;">
              <svg style="width: 24px; height: 24px;">
                <use xlink:href="#circle" />
              </svg>
            </i>
          </div>
        </button>
        <button class="button button-async" id="copyButton" onclick="copyTableToClipboard()" style="display:none;">
          <span><span class="button-async__label">Copy Table</span></span>
          <div class="loading-icon">
            <i class="icon icon-circle" style="width: 24px; height: 24px;">
              <svg style="width: 24px; height: 24px;">
                <use xlink:href="#circle" />
              </svg>
            </i>
          </div>
        </button>
      </div>
      <div id="historyToggleContainer" class="options-container collapsed" style="margin-top: 1em; border: 1px solid #ccc; border-radius: 6px;">
        <h4 style="margin-top: 0; cursor: pointer;" onclick="toggleHistory()">Recent Itineraries ▾</h4>
        <div id="historyListWrapper" style="margin-top: 8px; display: none;"></div>
      </div>
    </div>
  </div>
  <div class="output-container container" style="display: none; margin-top: 24px;">
    <div style="overflow-x: auto;">
      <div id="flightTableWrapper"></div>
    </div>
  </div>
</main>

<script>
  function getAirlineLogo(iataCode) {
    if (!iataCode) return "";
    return `https://pnrexpert.b-cdn.net/images/airlines/${iataCode.toLowerCase()}.png`;
  }

  // Helper to get duration in hours and minutes
  function calculateDuration(depDate, depTime, arrDate, arrTime) {
    const dep = new Date(`${depDate}T${depTime}`);
    const arr = new Date(`${arrDate}T${arrTime}`);
    const diffMs = arr - dep;
    const diffMin = Math.floor(diffMs / 60000);
    const hours = Math.floor(diffMin / 60);
    const minutes = diffMin % 60;
    return `${hours}h ${minutes}m`;
  }

  // Helper to group flights into outbound/inbound based on direction
  function groupFlightsByDirection(flights) {
    const origin = flights[0]?.departure?.airport;
    const groups = [{ label: "Outbound", flights: [] }];
    let currentGroup = groups[0];

    for (let i = 0; i < flights.length; i++) {
      const f = flights[i];
      const isReturn = f.departure.airport === origin && currentGroup.label !== "Inbound";
      if (isReturn && i !== 0) {
        currentGroup = { label: "Inbound", flights: [] };
        groups.push(currentGroup);
      }
      currentGroup.flights.push(f);
    }

    return groups;
  }

  function renderFlightTable(apiData) {
    const flights = apiData.data?.flights || [];
    saveItineraryToHistory(apiData);
    if (!flights.length) {
      document.getElementById("flightTableWrapper").innerHTML = '<p style="color:red;">No flights found.</p>';
      document.querySelector(".output-container").style.display = "block";
      return;
    }

    // Extract passengers array
    const passengers = apiData.data?.passengers || [];
    // Build passenger name array
    const passengerNames = passengers.map(p => p.name).filter(Boolean);
    let html = "";

    const formattedFlights = flights.map(f => ({
      flightNumber: f.flightNumber,
      airline: f.airlineName,
      iataCode: f.iataCode,
      bookingClass: f.bookingClass,
      cabin: f.cabin,
      departure: {
        airport: f.departingFrom.airportCode,
        city: f.departingFrom.cityName,
        airportName: f.departingFrom.airportName || f.departingFrom.cityName,
        date: f.departingFrom.time.split("T")[0],
        time: f.departingFrom.time.split("T")[1].substring(0, 5)
      },
      arrival: {
        airport: f.arrivingAt.airportCode,
        city: f.arrivingAt.cityName,
        airportName: f.arrivingAt.airportName || f.arrivingAt.cityName,
        date: f.arrivingAt.time.split("T")[0],
        time: f.arrivingAt.time.split("T")[1].substring(0, 5)
      },
      duration: `${(f.flightDuration.days * 24 + f.flightDuration.hours)}h ${f.flightDuration.minutes}m`,
      operatedBy: f.operatedBy
    }));

    // Store formatted data in global variables for checkbox toggling
    window._cachedFormattedFlights = formattedFlights;
    window._cachedPassengerNames = passengerNames;

    // Add style toggle if not present or not already in output-container
    const existingToggle = document.getElementById("styleToggleContainer");
    if (!existingToggle || !document.querySelector(".output-container").contains(existingToggle)) {
      const optionsDiv = document.createElement("div");
      optionsDiv.className = "options-container";
      optionsDiv.id = "styleToggleContainer";
      optionsDiv.style = "margin-bottom: 16px; border: 1px solid #ccc; border-radius: 6px; padding: 12px;";
      optionsDiv.innerHTML = `
    <h4 style="margin-top: 0; cursor: pointer;" onclick="toggleFormattingOptions()">Formatting Options ▾</h4>
    <div id="formattingOptionsBody" style="margin-top: 8px; display: none;">
      <label style="display: inline-flex; align-items: center; gap: 8px; font-size: 14px;">
        <input type="checkbox" id="styleToggle" checked />
        <span style="white-space: nowrap;">Include Itinerary Summary</span>
      </label>
    </div>
  `;
      document.querySelector(".output-container").prepend(optionsDiv);
      document.getElementById("styleToggle").addEventListener("change", () => {
        renderFlightTableFromInternalFormat(
          { result: { itinerary: window._cachedFormattedFlights } },
          "",
          window._cachedPassengerNames
        );
      });
    }

    renderFlightTableFromInternalFormat({ result: { itinerary: formattedFlights } }, html, passengerNames);
    document.querySelector(".output-container").style.display = "block";
  }

  function renderFlightTableFromInternalFormat(data, preTableHtml = "", passengerNames = []) {
    const flights = data.result.itinerary;
    const groups = groupFlightsByDirection(flights);
    // Ensure preTableHtml is only added once and not overwritten.
    let html = preTableHtml;

    // Check style toggle
    const showSummaries = document.getElementById("styleToggle")?.checked !== false;

    // Build itinerary summary based strictly on the start and end of each journey as rendered in the "Flight 1", "Flight 2", etc. blocks
    if (showSummaries && flights.length > 0) {
      const journeys = [];
      let journeyStartIndex = 0;

      for (let i = 0; i < flights.length; i++) {
        const current = flights[i];
        const next = flights[i + 1];

        const lastArrival = new Date(`${current.arrival.date}T${current.arrival.time}`);

        const shouldSplit = !next || (() => {
          const nextDeparture = new Date(`${next.departure.date}T${next.departure.time}`);
          const diffHrs = (nextDeparture - lastArrival) / 1000 / 60 / 60;
          return diffHrs >= 24;
        })();

        if (shouldSplit) {
          const journeyFlights = flights.slice(journeyStartIndex, i + 1);
          const fromCity = journeyFlights[0].departure.city;
          const toCity = journeyFlights[journeyFlights.length - 1].arrival.city;
          journeys.push({ from: fromCity, to: toCity });
          journeyStartIndex = i + 1;
        }
      }

      // Build itinerary summary
      let summary = "";
      for (let i = 0; i < journeys.length; i++) {
        const j = journeys[i];
        if (i === 0) {
          summary += `${j.from} → ${j.to}`;
        } else {
          const prev = journeys[i - 1];
          const connector = (prev.to === j.from) ? " → " : " / ";
          // Only show the 'from' city if different from the previous 'to'
          summary += connector + (j.from !== prev.to ? `${j.from} → ` : "") + j.to;
        }
      }

      html += `<h3 style="margin-bottom:0;">Itinerary: ${summary}</h3>`;
    }

    if (passengerNames.length === 1) {
      html += `<br><p><strong>Traveller:</strong><br>${passengerNames[0]}</p>`;
    } else if (passengerNames.length > 1) {
      html += `<br><p><strong>Travellers:</strong><br>${passengerNames.join("<br>")}</p>`;
    }

    // If showSummaries is false, render a single unified table and return.
    if (!showSummaries) {
      const allFlights = groups.flatMap(group => group.flights);
      const showCabin = allFlights.some(f => f.cabin);
      const transitTimes = allFlights.map((f, i, arr) => {
        if (i >= arr.length - 1) return null;
        const currArrival = new Date(`${f.arrival.date}T${f.arrival.time}`);
        const nextDeparture = new Date(`${arr[i + 1].departure.date}T${arr[i + 1].departure.time}`);
        const diffMs = nextDeparture - currArrival;
        const diffHrs = diffMs / 1000 / 60 / 60;
        return diffHrs < 24 ? `${Math.floor(diffHrs)}h ${Math.round((diffHrs % 1) * 60)}m` : null;
      });
      const hasTransit = transitTimes.some(Boolean);

      html += `<table>
        <tr>
          <th></th>
          <th>Date</th>
          <th>Airline</th>
          <th>Flight No</th>
          ${showCabin ? '<th>Cabin</th>' : ''}
          <th colspan="2">Departs</th>
          <th colspan="2">Arrives</th>
          <th>Duration</th>
          ${hasTransit ? '<th>Transit</th>' : ''}
        </tr>`;

      allFlights.forEach((f, i) => {
        const logo = getAirlineLogo(f.iataCode);
        const depDate = new Date(f.departure.date);
        const formattedDate = depDate.toLocaleDateString("en-GB", {
          weekday: "short", day: "numeric", month: "short"
        });

        html += `
        <tr>
          <td class="logo-cell">${logo ? `<img src="${logo}" alt="${f.airline} logo">` : ""}</td>
          <td>${formattedDate}</td>
          <td>
            <div>${f.airline}</div>
            ${f.operatedBy?.airlineName ? `<div class="operated-by">Operated by ${f.operatedBy.airlineName}</div>` : ""}
          </td>
          <td>${f.flightNumber.replace(/[^\d]/g, "")}</td>
          ${showCabin ? `<td>${f.cabin || f.bookingClass}</td>` : ""}
          <td colspan="2">
            ${f.departure.airportName} (${f.departure.airport})<br>
            <strong>${formatTime(f.departure.time)}</strong>
          </td>
          <td colspan="2">
            ${f.arrival.airportName} (${f.arrival.airport})<br>
            <strong>${(() => {
              const dep = new Date(`${f.departure.date}T${f.departure.time}`);
              const arr = new Date(`${f.arrival.date}T${f.arrival.time}`);
              const formatted = formatTime(f.arrival.time);
              return arr.getDate() !== dep.getDate()
                ? `${formatted} <span style="color: #555;">(On ${arr.toLocaleDateString("en-GB", { day: "numeric", month: "short" })})</span>`
                : formatted;
            })()}</strong>
          </td>
          <td>${f.duration}</td>
          ${hasTransit ? `<td>${transitTimes[i] || ""}</td>` : ""}
        </tr>`;
      });

      html += "</table>";
      document.getElementById("flightTableWrapper").innerHTML = html;
      document.getElementById("copyButton").style.display = "inline-block";
      return;
    }

    groups.forEach((group, gIndex) => {
      const showCabin = group.flights.some(f => f.cabin);
      const transitTimes = group.flights.map((f, i, arr) => {
        if (i >= arr.length - 1) return null;
        const currArrival = new Date(`${f.arrival.date}T${f.arrival.time}`);
        const nextDeparture = new Date(`${arr[i + 1].departure.date}T${arr[i + 1].departure.time}`);
        const diffMs = nextDeparture - currArrival;
        const diffHrs = diffMs / 1000 / 60 / 60;
        return diffHrs < 24 ? `${Math.floor(diffHrs)}h ${Math.round((diffHrs % 1) * 60)}m` : null;
      });
      const hasTransit = transitTimes.some(t => t !== null);

      // Removed old from and totalDuration calculation

      let journeySummaries = [];
      if (showSummaries) {
        journeySummaries = [];
        let journeyStartIndex = 0;
        for (let i = 0; i < group.flights.length; i++) {
          const current = group.flights[i];
          const next = group.flights[i + 1];
          const lastArrival = new Date(`${current.arrival.date}T${current.arrival.time}`);
          const shouldSplit = !next || (() => {
            const nextDeparture = new Date(`${next.departure.date}T${next.departure.time}`);
            const diffHrs = (nextDeparture - lastArrival) / 1000 / 60 / 60;
            return diffHrs >= 24;
          })();
          if (shouldSplit) {
            const journeyFlights = group.flights.slice(journeyStartIndex, i + 1);
            const fromCity = journeyFlights[0].departure.city;
            const toCity = journeyFlights[journeyFlights.length - 1].arrival.city;
            let viaCity = "";
            if (journeyFlights.length > 1) {
              const stops = journeyFlights.slice(0, -1).map(f => f.arrival.city);
              const uniqueStops = [...new Set(stops)];
              if (uniqueStops.length === 1) {
                viaCity = ` (via ${uniqueStops[0]})`;
              } else if (uniqueStops.length === 2) {
                viaCity = ` (via ${uniqueStops.join(" & ")})`;
              } else if (uniqueStops.length > 2) {
                viaCity = ` (via ${uniqueStops.slice(0, -1).join(", ")} & ${uniqueStops.at(-1)})`;
              }
            }
            // Sum total time: flight durations + transit
            let totalMin = 0;
            for (let j = 0; j < journeyFlights.length; j++) {
              const durMatch = journeyFlights[j].duration.match(/(\d+)h\s?(\d+)m/);
              const flightMin = parseInt(durMatch[1]) * 60 + parseInt(durMatch[2]);
              totalMin += flightMin;
              // Add transit time if not last segment
              if (j < journeyFlights.length - 1) {
                const arr = new Date(`${journeyFlights[j].arrival.date}T${journeyFlights[j].arrival.time}`);
                const dep = new Date(`${journeyFlights[j + 1].departure.date}T${journeyFlights[j + 1].departure.time}`);
                const transitMin = Math.floor((dep - arr) / 60000);
                totalMin += transitMin;
              }
            }
            const h = Math.floor(totalMin / 60);
            const m = totalMin % 60;
            journeySummaries.push(`Flight ${journeySummaries.length + 1}: ${fromCity} → ${toCity}${viaCity} – ${h}h ${m}m`);
            journeyStartIndex = i + 1;
          }
        }
      }
      const journeySummaryText = journeySummaries.map(s => `<div>${s}</div>`).join("");

      const headerRow = `
        <tr>
          <th style="background-color:#e6e8ea; color:#000; padding:8px 10px; font-size:12px;"></th>
          <th style="background-color:#e6e8ea; color:#000; padding:8px 10px; font-size:12px;">Date</th>
          <th style="background-color:#e6e8ea; color:#000; padding:8px 10px; font-size:12px;">Airline</th>
          <th style="background-color:#e6e8ea; color:#000; padding:8px 10px; font-size:12px;">Flight No</th>
          ${showCabin ? '<th style="background-color:#e6e8ea; color:#000; padding:8px 10px; font-size:12px;">Cabin</th>' : ""}
          <th colspan="2" style="background-color:#e6e8ea; color:#000; padding:8px 10px; font-size:12px;">Departs</th>
          <th colspan="2" style="background-color:#e6e8ea; color:#000; padding:8px 10px; font-size:12px;">Arrives</th>
          <th style="background-color:#e6e8ea; color:#000; padding:8px 10px; font-size:12px;">Duration</th>
          ${hasTransit ? '<th style="background-color:#e6e8ea; color:#000; padding:8px 10px; font-size:12px;">Transit</th>' : ""}
        </tr>
      `;

      // Only show group label if there is more than one group and showSummaries is enabled
      const groupTitle = (groups.length > 1 && showSummaries) ? `<div style="margin-bottom: 4px;"><strong>${group.label}</strong></div>` : "";
      html += `
        <div style="margin: 8px 0; font-weight: bold;">${groupTitle}</div>
        <table>
      `;

      // Insert journey separator rows
      let rows = "";
      group.flights.forEach((f, i) => {
        const logoIata = f.iataCode;
        const logo = getAirlineLogo(logoIata);
        const depDate = new Date(f.departure.date);
        const formattedDate = depDate.toLocaleDateString("en-GB", {
          weekday: "short", day: "numeric", month: "short"
        });
        // Only show the scheduled flight duration per row (do not add transit)
        const duration = f.duration;
        const cabinCell = showCabin ? `<td>${f.cabin || f.bookingClass}</td>` : "";

        const isNewJourney = (i === 0 || (() => {
          const prev = group.flights[i - 1];
          const prevArr = new Date(`${prev.arrival.date}T${prev.arrival.time}`);
          const thisDep = new Date(`${f.departure.date}T${f.departure.time}`);
          return (thisDep - prevArr) / 1000 / 60 / 60 >= 24;
        })());

        let journeyIndex = 0;
        let journeyCursor = 0;
        for (let j = 0; j < i; j++) {
          const prev = group.flights[j];
          const next = group.flights[j + 1];
          if (!next) break;
          const prevArr = new Date(`${prev.arrival.date}T${prev.arrival.time}`);
          const nextDep = new Date(`${next.departure.date}T${next.departure.time}`);
          if ((nextDep - prevArr) / 1000 / 60 / 60 >= 24) {
            journeyCursor++;
          }
        }
        journeyIndex = journeyCursor;

        let journeySummary = journeySummaries[journeyIndex];
        if (showSummaries && journeySummaries.length === 1) {
          journeySummary = journeySummary.replace(/^Flight 1: /, "");
        } else if (
          showSummaries &&
          journeySummaries.length === 2 &&
          journeySummaries.every(j => j.startsWith("Flight "))
        ) {
          const firstDepCity = group.flights[0].departure.city;
          const lastArrCity = group.flights[group.flights.length - 1].arrival.city;

          if (firstDepCity && lastArrCity && firstDepCity === lastArrCity) {
            if (journeyIndex === 0) {
              journeySummary = journeySummary.replace(/^Flight 1: /, "Outbound: ");
            } else if (journeyIndex === 1) {
              journeySummary = journeySummary.replace(/^Flight 2: /, "Inbound: ");
            }
          }
        }

        const headerRowSegmented = `
          <tr>
            <th style="background-color:#e6e8ea; color:#000; padding:8px 10px; font-size:12px;"></th>
            <th style="background-color:#e6e8ea; color:#000; padding:8px 10px; font-size:12px;">Date</th>
            <th style="background-color:#e6e8ea; color:#000; padding:8px 10px; font-size:12px;">Airline</th>
            <th style="background-color:#e6e8ea; color:#000; padding:8px 10px; font-size:12px;">Flight No</th>
            ${showCabin ? '<th style="background-color:#e6e8ea; color:#000; padding:8px 10px; font-size:12px;">Cabin</th>' : ""}
            <th colspan="2" style="background-color:#e6e8ea; color:#000; padding:8px 10px; font-size:12px;">Departs</th>
            <th colspan="2" style="background-color:#e6e8ea; color:#000; padding:8px 10px; font-size:12px;">Arrives</th>
            <th style="background-color:#e6e8ea; color:#000; padding:8px 10px; font-size:12px;">Duration</th>
            ${hasTransit ? '<th style="background-color:#e6e8ea; color:#000; padding:8px 10px; font-size:12px;">Transit</th>' : ""}
          </tr>
        `;
        // Only show a single header row and avoid duplication when summaries are toggled off
        const journeyHeader = (() => {
          if (showSummaries && journeySummary) {
            if (isNewJourney || i === 0) {
              return `
                <tr>
                  <td colspan="${hasTransit ? 11 : 10}" style="font-weight:bold; border: none; background: none;">${journeySummary}</td>
                </tr>
                ${headerRowSegmented}
              `;
            }
            return "";
          }
          if (!showSummaries && gIndex === 0 && i === 0) {
            return headerRowSegmented;
          }
          return "";
        })();
        rows += `
          ${journeyHeader}
          <tr>
            <td class="logo-cell">${logo ? `<img src="${logo}" alt="${f.airline} logo">` : ""}</td>
            <td>${formattedDate}</td>
            <td>
              <div>${f.airline}</div>
              ${f.operatedBy?.airlineName ? `<div class="operated-by">Operated by ${f.operatedBy.airlineName}</div>` : ""}
            </td>
            <td>${f.flightNumber.replace(/[^\d]/g, "")}</td>
            ${cabinCell}
            <td colspan="2">
              ${f.departure.airportName} (${f.departure.airport})<br>
              <strong>${formatTime(f.departure.time)}</strong>
            </td>
            <td colspan="2">
              ${f.arrival.airportName} (${f.arrival.airport})<br>
              <strong>${(() => {
                const depDateTime = new Date(`${f.departure.date}T${f.departure.time}:00`);
                const arrDateTime = new Date(`${f.arrival.date}T${f.arrival.time}:00`);
                const formattedTime = formatTime(f.arrival.time);
                if (arrDateTime.getDate() !== depDateTime.getDate()) {
                  const suffix = arrDateTime.toLocaleDateString("en-GB", { day: 'numeric', month: 'short' });
                  return `${formattedTime} <span style="color: #555;">(On ${suffix})</span>`;
                }
                return formattedTime;
              })()}</strong>
            </td>
            <td>${duration}</td>
            ${hasTransit ? `<td>${transitTimes[i] || ""}</td>` : ""}
          </tr>
        `;
      });

      html += rows + "</table>";
    });

    document.getElementById("flightTableWrapper").innerHTML = html;
    // Only show copy button if html contains a table (i.e., actual table content)
    if (html.includes("<table")) {
      document.getElementById("copyButton").style.display = "inline-block";
    } else {
      document.getElementById("copyButton").style.display = "none";
    }
  }

  function formatTime(time24) {
    const [hourStr, min] = time24.split(":");
    let hour = parseInt(hourStr);
    const ampm = hour >= 12 ? "pm" : "am";
    hour = hour % 12 || 12;
    return `${hour}:${min} ${ampm}`;
  }

  function copyTableToClipboard() {
    const copyBtn = document.getElementById("copyButton");
    copyBtn.classList.add("button-async--loading");
    // Set label to "Copied" and save original text
    const labelSpan = copyBtn.querySelector(".button-async__label");
    const originalText = labelSpan.textContent;
    labelSpan.textContent = "Copied";
    const wrapper = document.getElementById("flightTableWrapper");
    if (!wrapper) return;

    // Clone and apply light-mode styles
    const clone = wrapper.cloneNode(true);
    // Style th cells
    clone.querySelectorAll("th").forEach(el => {
      el.style.backgroundColor = "#e6e8ea";
el.style.color = "#000";
el.style.borderColor = "#333";
el.style.fontWeight = "bold";
el.style.padding = "6px 8px";
el.style.lineHeight = "1.4";
el.style.fontSize = "12px";
el.style.whiteSpace = "nowrap";
    });
    // Style td cells
    clone.querySelectorAll("td").forEach(el => {
      el.style.backgroundColor = "#fff";
      el.style.color = "#000";
      el.style.borderColor = "#333";
    });
    // Style table borders
    clone.querySelectorAll("table").forEach(el => {
      el.style.borderColor = "#333";
    });
    // Apply light-mode styles to all text elements (headings, paragraphs, etc)
    clone.querySelectorAll("*").forEach(el => {
      el.style.color = "#000";
      el.style.fontFamily = "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif";
      if (el.tagName.toLowerCase() === "p" || el.tagName.toLowerCase() === "h3") {
        el.style.backgroundColor = "#fff";
      }
    });


    // Style "Operated by" lines
    clone.querySelectorAll(".operated-by").forEach(el => {
      el.style.fontSize = "90%";
      el.style.color = "#555";
      el.style.fontFamily = "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif";
      el.style.lineHeight = "1.4";
    });

    // Explicitly set fixed dimensions for airline logos in copied table as inline style attribute (stricter for email compatibility)
    clone.querySelectorAll("td img").forEach(el => {
      el.removeAttribute("style");
      el.removeAttribute("height");
      el.setAttribute("width", "100");
      el.setAttribute("style", "display:inline-block; vertical-align:middle; object-fit:contain; max-height:50px;");
    });

    // Prepare hidden container
    const hiddenDiv = document.createElement("div");
    hiddenDiv.style.position = "fixed";
    hiddenDiv.style.top = "-9999px";
    hiddenDiv.appendChild(clone);
    document.body.appendChild(hiddenDiv);

    const range = document.createRange();
    range.selectNode(clone);
    const selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(range);

    try {
      document.execCommand("copy");
    } catch (err) {
      console.error("Failed to copy table.", err);
    }

    selection.removeAllRanges();
    document.body.removeChild(hiddenDiv);
    setTimeout(() => {
      copyBtn.classList.remove("button-async--loading");
      labelSpan.textContent = originalText;
    }, 600);
  }

  function fetchFlightData() {
    const pnr = document.getElementById("pnrInput").value.trim();
    if (!pnr) {
      alert("Please enter a PNR.");
      return;
    }
    const submitBtn = document.getElementById("submitBtn");
    submitBtn.classList.add("button-async--loading");
    document.getElementById("flightTableWrapper").innerHTML = "";
    // Hide copy button before making fetch call
    document.getElementById("copyButton").style.display = "none";

    fetch("https://pnr-proxy.vercel.app/api/pnr", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6ImM1OTE5NjViLWI0N2QtNDM1MC1iNGNiLTdjODYyNTRmNDg1YiIsImlhdCI6MTc0NjQ4MjEwMH0.HGIbM8jp_uzA8vCBKvUXSPyTSbL-UTA_4k7rSG8gmzA"
      },
      body: JSON.stringify({ pnr })
    })
    .then(res => res.json())
    .then(data => {
      submitBtn.classList.remove("button-async--loading");
      if (!data || !data.data || !data.data.flights) {
        document.getElementById("flightTableWrapper").innerHTML = '<p style="color:red;">Invalid or incomplete PNR response.</p>';
        return;
      }
      renderFlightTable(data);
      document.getElementById("pnrInput").value = "";
    })
    .catch(err => {
      submitBtn.classList.remove("button-async--loading");
      console.error("Error:", err);
      document.getElementById("flightTableWrapper").innerHTML = '<p style="color:red;">Unexpected Error:<br>Load failed</p>';
    });
  }
  // --- History functions ---
  function saveItineraryToHistory(data) {
    const history = JSON.parse(localStorage.getItem("itineraryHistory") || "[]");
    history.unshift({ timestamp: Date.now(), data });
    localStorage.setItem("itineraryHistory", JSON.stringify(history.slice(0, 10)));
    renderHistoryList();
  }

  function renderHistoryList() {
    let history = JSON.parse(localStorage.getItem("itineraryHistory") || "[]");
    const wrapper = document.getElementById("historyListWrapper");
    if (!wrapper) return;
    wrapper.innerHTML = "";
    wrapper.style.display = "none";
    const historyContainer = document.getElementById("historyToggleContainer");
    if (history.length === 0) {
      if (historyContainer) {
        historyContainer.style.display = "none";
      }
      return;
    } else {
      if (historyContainer) {
        historyContainer.style.display = "block";
      }
    }

    const list = document.createElement("ul");
    list.style.listStyle = "none";
    list.style.paddingLeft = "0";

    history.forEach((item, index) => {
      const li = document.createElement("li");
      const date = new Date(item.timestamp);
      // New formattedDate logic for Today/Yesterday
      const now = new Date();
      const isToday = date.toDateString() === now.toDateString();
      const isYesterday = date.toDateString() === new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1).toDateString();
      const time = date.toLocaleTimeString("en-AU", { hour: "numeric", minute: "2-digit" });

      let formattedDate = "";
      if (isToday) {
        formattedDate = `Today at ${time}`;
      } else if (isYesterday) {
        formattedDate = `Yesterday at ${time}`;
      } else {
        formattedDate = date.toLocaleString("en-AU", { day: "numeric", month: "short", hour: "numeric", minute: "2-digit" });
      }

      const flights = item.data?.data?.flights || [];
      const passengers = item.data?.data?.passengers || [];
      // Use new extraction logic for passenger name
      const name = passengers.length ? passengers[0].name.split("/")[0] + " " : "";

      // Generate summary label using same logic as table summary
      let summary = "";
      const journeys = [];
      let journeyStartIndex = 0;
      for (let i = 0; i < flights.length; i++) {
        const current = flights[i];
        const next = flights[i + 1];
        const lastArrival = new Date(`${current.arrivingAt.time}`);
        const shouldSplit = !next || (() => {
          const nextDeparture = new Date(`${next.departingFrom.time}`);
          return (nextDeparture - lastArrival) / 1000 / 60 / 60 >= 24;
        })();
        if (shouldSplit) {
          const journeyFlights = flights.slice(journeyStartIndex, i + 1);
          const from = journeyFlights[0]?.departingFrom?.cityName || "";
          const to = journeyFlights.at(-1)?.arrivingAt?.cityName || "";
          journeys.push({ from, to });
          journeyStartIndex = i + 1;
        }
      }
      summary = journeys.map((j, i, arr) => {
        if (i === 0) return `${j.from} → ${j.to}`;
        const prev = arr[i - 1];
        const connector = (prev.to === j.from) ? " → " : " / ";
        return connector + (j.from !== prev.to ? `${j.from} → ` : "") + j.to;
      }).join("");
      // Main history button
      const button = document.createElement("button");
      button.className = "button";
      button.style.fontSize = "12px";
      button.style.padding = "6px 10px";
      button.style.marginBottom = "8px";
      button.style.backgroundColor = "var(--base-color-brand--primary, #2266ed)";
      button.style.color = "var(--base-color-foreground-on-primary, white)";

      // Build truncated summary (name+summary) and always show full date
      const labelSpan = document.createElement("span");
      const dateSpan = document.createElement("span");

      labelSpan.textContent = `${name}${summary} `;
      dateSpan.textContent = `(${formattedDate})`;

      labelSpan.style.display = "inline-block";
      labelSpan.style.whiteSpace = "nowrap";
      labelSpan.style.overflow = "hidden";
      labelSpan.style.textOverflow = "ellipsis";
      labelSpan.style.flex = "1";

      dateSpan.style.flex = "none";
      dateSpan.style.marginLeft = "8px";
      dateSpan.style.whiteSpace = "nowrap";

      const wrapperDiv = document.createElement("div");
      wrapperDiv.style.flex = "1";
      wrapperDiv.style.display = "flex";
      wrapperDiv.style.justifyContent = "space-between";
      wrapperDiv.style.alignItems = "center";
      wrapperDiv.style.textAlign = "left";
      wrapperDiv.style.overflow = "hidden";

      wrapperDiv.appendChild(labelSpan);
      wrapperDiv.appendChild(dateSpan);

      button.textContent = "";
      button.style.display = "flex";
      button.style.alignItems = "center";
      button.style.width = "100%";
      button.style.textAlign = "left";
      button.appendChild(wrapperDiv);

      button.onclick = () => loadFromHistory(index);
      // Match .button hover
      button.onmouseover = function() {
        button.style.backgroundColor = "var(--base-color-brand--primary-dark, #1a50c1)";
      };
      button.onmouseout = function() {
        button.style.backgroundColor = "var(--base-color-brand--primary, #2266ed)";
      };

      li.appendChild(button);
      list.appendChild(li);
    });

    wrapper.appendChild(list);
    // Add Clear History button
    const clearBtn = document.createElement("button");
    clearBtn.textContent = "Clear History";
    clearBtn.className = "button";
    clearBtn.style.backgroundColor = "#ccc";
    clearBtn.style.color = "#000";
    clearBtn.style.fontSize = "12px";
    clearBtn.style.padding = "6px 10px";
    clearBtn.style.marginTop = "8px";
    clearBtn.onclick = () => {
      localStorage.removeItem("itineraryHistory");
      renderHistoryList();
    };
    wrapper.appendChild(clearBtn);
  }

  function loadFromHistory(index) {
    const history = JSON.parse(localStorage.getItem("itineraryHistory") || "[]");
    const item = history[index];
    if (item) {
      const flights = item.data?.data?.flights || [];
      const passengers = item.data?.data?.passengers || [];
      const formattedFlights = flights.map(f => ({
        flightNumber: f.flightNumber,
        airline: f.airlineName,
        iataCode: f.iataCode,
        bookingClass: f.bookingClass,
        cabin: f.cabin,
        departure: {
          airport: f.departingFrom.airportCode,
          city: f.departingFrom.cityName,
          airportName: f.departingFrom.airportName || f.departingFrom.cityName,
          date: f.departingFrom.time.split("T")[0],
          time: f.departingFrom.time.split("T")[1].substring(0, 5)
        },
        arrival: {
          airport: f.arrivingAt.airportCode,
          city: f.arrivingAt.cityName,
          airportName: f.arrivingAt.airportName || f.arrivingAt.cityName,
          date: f.arrivingAt.time.split("T")[0],
          time: f.arrivingAt.time.split("T")[1].substring(0, 5)
        },
        duration: `${(f.flightDuration.days * 24 + f.flightDuration.hours)}h ${f.flightDuration.minutes}m`,
        operatedBy: f.operatedBy
      }));

      window._cachedFormattedFlights = formattedFlights;
      window._cachedPassengerNames = passengers.map(p => p.name).filter(Boolean);
      document.querySelector(".output-container").style.display = "block";

      // Add formatting toggle if needed
      const existingToggle = document.getElementById("styleToggleContainer");
      if (!existingToggle || !document.querySelector(".output-container").contains(existingToggle)) {
        const optionsDiv = document.createElement("div");
        optionsDiv.className = "options-container";
        optionsDiv.id = "styleToggleContainer";
        optionsDiv.style = "margin-bottom: 16px; border: 1px solid #ccc; border-radius: 6px; padding: 12px;";
        optionsDiv.innerHTML = `
          <h4 style="margin-top: 0; cursor: pointer;" onclick="toggleFormattingOptions()">Formatting Options ▾</h4>
          <div id="formattingOptionsBody" style="margin-top: 8px; display: none;">
            <label style="display: inline-flex; align-items: center; gap: 8px; font-size: 14px;">
              <input type="checkbox" id="styleToggle" checked />
              <span style="white-space: nowrap;">Include Itinerary Summary</span>
            </label>
          </div>
        `;
        document.querySelector(".output-container").prepend(optionsDiv);
        document.getElementById("styleToggle").addEventListener("change", () => {
          renderFlightTableFromInternalFormat(
            { result: { itinerary: window._cachedFormattedFlights } },
            "",
            window._cachedPassengerNames
          );
        });
      }

      renderFlightTableFromInternalFormat({ result: { itinerary: formattedFlights } }, "", window._cachedPassengerNames);
    }
  }

  // (togglePin function removed)

  function toggleHistory() {
    const wrapper = document.getElementById("historyListWrapper");
    const header = document.querySelector("#historyToggleContainer h4");
    const container = document.getElementById("historyToggleContainer");
    const isOpen = wrapper.style.display === "none";
    wrapper.style.display = isOpen ? "block" : "none";
    container.classList.toggle("collapsed", !isOpen);
    header.textContent = isOpen ? "Recent Itineraries ▴" : "Recent Itineraries ▾";
  }

  // Toggle formatting options (collapsible)
  function toggleFormattingOptions() {
    const body = document.getElementById("formattingOptionsBody");
    const header = document.querySelector("#styleToggleContainer h4");
    if (!body || !header) return;
    const container = document.getElementById("styleToggleContainer");
    const isOpen = body.style.display === "none";
    body.style.display = isOpen ? "block" : "none";
    container.classList.toggle("collapsed", !isOpen);
    header.textContent = isOpen ? "Formatting Options ▴" : "Formatting Options ▾";
  }

  // Initialize history on page load
  document.addEventListener("DOMContentLoaded", () => {
    renderHistoryList();
  });
  // Only show the header if not inside an iframe
  if (window.top === window.self) {
    const header = document.querySelector(".browser-header");
    if (header) header.style.display = "block";
  }
</script>

</div>
<footer style="margin-top: 48px; text-align: center; font-size: 8px; color: #888;">
  Travel Tailor PNR Converter – Version 1.0 (0905)
<br>
<br>
</footer>
</body>
</html>
