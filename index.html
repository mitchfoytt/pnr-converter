<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>PNR Flight Table Preview</title>
  <link href="https://integrations.missiveapp.com/missive.css" rel="stylesheet">
  <script src="https://integrations.missiveapp.com/missive.js"></script>
  <style>
    body {
      background-color: #f5f6f7;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
      padding: 16px;
    }
    .container {
      background: white;
      border: 1px solid #d0d3d6;
      padding: 16px;
      border-radius: 6px;
      max-width: 100%;
    }
    @media (max-width: 600px) {
      .container {
        padding: 12px;
      }
    }
    textarea.input {
      width: 100%;
      border: 1px solid var(--base-color-neutral--300, #d0d3d6);
      background-color: var(--base-color-surface-default, #fff);
      color: inherit;
      font-size: 14px;
      padding: 12px;
      border-radius: 6px;
      resize: vertical;
      font-family: inherit;
    }
    .button {
      background-color: var(--base-color-brand--primary, #2266ed);
      color: var(--base-color-foreground-on-primary, white);
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      cursor: pointer;
    }
    .button:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(34, 102, 237, 0.3);
    }
    .button:hover {
      background-color: var(--base-color-brand--primary-dark, #1a50c1);
      color: var(--base-color-foreground-on-primary, white);
    }
    .button-async,
    .button-async:hover {
      background-color: var(--base-color-brand--primary, #2266ed) !important;
      color: var(--base-color-foreground-on-primary, white) !important;
    }
    .button-async--loading,
    .button-async--loading:hover {
      opacity: 1 !important;
      background-color: var(--base-color-brand--primary-dark, #1a50c1) !important;
      color: var(--base-color-foreground-on-primary, white) !important;
    }
    table {
      border-collapse: collapse;
      width: 880px;
      margin-top: 1em;
    }
    th, td {
      border: 1px solid #333;
      padding: 3px 5px;
      text-align: left;
      font-size: 12px;
    }
    th {
      background-color: #eee;
      font-size: 12px;
    }
    td img {
      width: 100px;
      height: auto;
      max-height: 35px;
      object-fit: contain;
      vertical-align: middle;
    }
</style>
  <style>
    @media (prefers-color-scheme: dark) {
      body {
        background-color: #1e1e1e;
        color: #ddd;
      }
      .container,
      .output-container {
        background-color: #2b2b2b;
        border-color: #444;
      }
      textarea.input {
        background-color: #333;
        color: #eee;
      }
      .button {
        background-color: #3a6ee8;
        color: white;
      }
      .button:hover {
        background-color: #2e59c5;
      }
      table {
        border-color: #555;
      }
      th {
        background-color: #444;
        color: #eee;
      }
      td {
        color: #ddd;
      }
      td img {
        filter: brightness(0.9);
      }
    }
  </style>
</head>
<body>
<div class="missive-integration">
  <div class="container">
    <h3 class="text-xlarge text-800">Travel Tailor - PNR Converter</h3>
    <textarea id="pnrInput" class="input" rows="8" style="width: 100%; height: 200px;" placeholder="Enter PNR here"></textarea>
    <div style="display: flex; gap: 12px; margin-top: 1em;">
      <button class="button button-async" id="submitBtn" onclick="fetchFlightData()" data-loading="Converting…" data-state="default">
        <span><span class="button-async-label">Convert PNR</span></span>
        <div class="loading-icon">
          <i class="icon icon-circle" style="width: 24px; height: 24px;">
            <svg style="width: 24px; height: 24px;">
              <use xlink:href="#circle" />
            </svg>
          </i>
        </div>
      </button>
      <button class="button button-async" id="copyButton" onclick="copyTableToClipboard()" style="display:none;">
        <span><span class="button-async__label">Copy Table</span></span>
        <div class="loading-icon">
          <i class="icon icon-circle" style="width: 24px; height: 24px;">
            <svg style="width: 24px; height: 24px;">
              <use xlink:href="#circle" />
            </svg>
          </i>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="output-container container" style="display: none; margin-top: 24px;">
  <div style="max-height: 500px; overflow-y: auto;">
    <div id="flightTableWrapper"></div>
  </div>
</div>

<script>
  function getAirlineLogo(iataCode) {
    if (!iataCode) return "";
    return `https://pnrexpert.b-cdn.net/images/airlines/${iataCode.toLowerCase()}.png`;
  }

  // Helper to get duration in hours and minutes
  function calculateDuration(depDate, depTime, arrDate, arrTime) {
    const dep = new Date(`${depDate}T${depTime}`);
    const arr = new Date(`${arrDate}T${arrTime}`);
    const diffMs = arr - dep;
    const diffMin = Math.floor(diffMs / 60000);
    const hours = Math.floor(diffMin / 60);
    const minutes = diffMin % 60;
    return `${hours}h ${minutes}m`;
  }

  // Helper to group flights into outbound/inbound based on direction
  function groupFlightsByDirection(flights) {
    const origin = flights[0]?.departure?.airport;
    const groups = [{ label: "Outbound", flights: [] }];
    let currentGroup = groups[0];

    for (let i = 0; i < flights.length; i++) {
      const f = flights[i];
      const isReturn = f.departure.airport === origin && currentGroup.label !== "Inbound";
      if (isReturn && i !== 0) {
        currentGroup = { label: "Inbound", flights: [] };
        groups.push(currentGroup);
      }
      currentGroup.flights.push(f);
    }

    return groups;
  }

  function renderFlightTable(apiData) {
    const flights = apiData.data?.flights || [];
    if (!flights.length) {
      document.getElementById("flightTableWrapper").innerHTML = '<p style="color:red;">No flights found.</p>';
      document.querySelector(".output-container").style.display = "block";
      return;
    }

    // Extract passengers array
    const passengers = apiData.data?.passengers || [];
    // Build passenger name array
    const passengerNames = passengers.map(p => p.name).filter(Boolean);
    let html = "";

    const formattedFlights = flights.map(f => ({
      flightNumber: f.flightNumber,
      airline: f.airlineName,
      iataCode: f.iataCode,
      bookingClass: f.bookingClass,
      cabin: f.cabin,
      departure: {
        airport: f.departingFrom.airportCode,
        city: f.departingFrom.cityName,
        airportName: f.departingFrom.airportName || f.departingFrom.cityName,
        date: f.departingFrom.time.split("T")[0],
        time: f.departingFrom.time.split("T")[1].substring(0, 5)
      },
      arrival: {
        airport: f.arrivingAt.airportCode,
        city: f.arrivingAt.cityName,
        airportName: f.arrivingAt.airportName || f.arrivingAt.cityName,
        date: f.arrivingAt.time.split("T")[0],
        time: f.arrivingAt.time.split("T")[1].substring(0, 5)
      },
      duration: `${f.flightDuration.hours}h ${f.flightDuration.minutes}m`,
      operatedBy: f.operatedBy
    }));

    // Add style toggle if not present
    if (!document.getElementById("styleToggleContainer")) {
      const optionsDiv = document.createElement("div");
      optionsDiv.className = "options-container";
      optionsDiv.style = "margin-bottom: 16px; padding: 12px; border: 1px solid #ccc; border-radius: 6px;";
      optionsDiv.innerHTML = `
  <h4 style="margin-top: 0;">Formatting Options</h4>
  <label style="display: inline-flex; align-items: center; gap: 8px; font-size: 14px;">
    <input type="checkbox" id="styleToggle" checked />
    <span style="white-space: nowrap;">Include Itinerary Summary</span>
  </label>
`;
      document.querySelector(".output-container").prepend(optionsDiv);
      document.getElementById("styleToggle").addEventListener("change", () => {
        renderFlightTableFromInternalFormat({ result: { itinerary: formattedFlights } }, "", passengerNames);
      });
    }

    renderFlightTableFromInternalFormat({ result: { itinerary: formattedFlights } }, html, passengerNames);
    document.querySelector(".output-container").style.display = "block";
  }

  function renderFlightTableFromInternalFormat(data, preTableHtml = "", passengerNames = []) {
    const flights = data.result.itinerary;
    const groups = groupFlightsByDirection(flights);
    // Ensure preTableHtml is only added once and not overwritten.
    let html = preTableHtml;

    // Check style toggle
    const showSummaries = document.getElementById("styleToggle")?.checked !== false;

    // Build itinerary summary based strictly on the start and end of each journey as rendered in the "Flight 1", "Flight 2", etc. blocks
    if (showSummaries && flights.length > 0) {
      const journeys = [];
      let journeyStartIndex = 0;

      for (let i = 0; i < flights.length; i++) {
        const current = flights[i];
        const next = flights[i + 1];

        const lastArrival = new Date(`${current.arrival.date}T${current.arrival.time}`);

        const shouldSplit = !next || (() => {
          const nextDeparture = new Date(`${next.departure.date}T${next.departure.time}`);
          const diffHrs = (nextDeparture - lastArrival) / 1000 / 60 / 60;
          return diffHrs >= 24;
        })();

        if (shouldSplit) {
          const journeyFlights = flights.slice(journeyStartIndex, i + 1);
          const fromCity = journeyFlights[0].departure.city;
          const toCity = journeyFlights[journeyFlights.length - 1].arrival.city;
          journeys.push({ from: fromCity, to: toCity });
          journeyStartIndex = i + 1;
        }
      }

      // Build itinerary summary
      let summary = "";
      for (let i = 0; i < journeys.length; i++) {
        const j = journeys[i];
        if (i === 0) {
          summary += `${j.from} → ${j.to}`;
        } else {
          const prev = journeys[i - 1];
          const connector = (prev.to === j.from) ? " → " : " / ";
          // Only show the 'from' city if different from the previous 'to'
          summary += connector + (j.from !== prev.to ? `${j.from} → ` : "") + j.to;
        }
      }

      html += `<h3 style="margin-bottom:0;">Itinerary: ${summary}</h3>`;
    }

    if (passengerNames.length === 1) {
      html += `<p><strong>Traveller:</strong><br>${passengerNames[0]}</p>`;
    } else if (passengerNames.length > 1) {
      html += `<p><strong>Travellers:</strong><br>${passengerNames.join("<br>")}</p>`;
    }

    groups.forEach((group, gIndex) => {
      const showCabin = group.flights.some(f => f.cabin);
      const transitTimes = group.flights.map((f, i, arr) => {
        if (i >= arr.length - 1) return null;
        const currArrival = new Date(`${f.arrival.date}T${f.arrival.time}`);
        const nextDeparture = new Date(`${arr[i + 1].departure.date}T${arr[i + 1].departure.time}`);
        const diffMs = nextDeparture - currArrival;
        const diffHrs = diffMs / 1000 / 60 / 60;
        return diffHrs < 24 ? `${Math.floor(diffHrs)}h ${Math.round((diffHrs % 1) * 60)}m` : null;
      });
      const hasTransit = transitTimes.some(t => t !== null);

      // Removed old from and totalDuration calculation

      let journeySummaries = [];
      if (showSummaries) {
        journeySummaries = [];
        let journeyStartIndex = 0;
        for (let i = 0; i < group.flights.length; i++) {
          const current = group.flights[i];
          const next = group.flights[i + 1];
          const lastArrival = new Date(`${current.arrival.date}T${current.arrival.time}`);
          const shouldSplit = !next || (() => {
            const nextDeparture = new Date(`${next.departure.date}T${next.departure.time}`);
            const diffHrs = (nextDeparture - lastArrival) / 1000 / 60 / 60;
            return diffHrs >= 24;
          })();
          if (shouldSplit) {
            const journeyFlights = group.flights.slice(journeyStartIndex, i + 1);
            const fromCity = journeyFlights[0].departure.city;
            const toCity = journeyFlights[journeyFlights.length - 1].arrival.city;
            let viaCity = "";
            if (journeyFlights.length > 1) {
              const stops = journeyFlights.slice(0, -1).map(f => f.arrival.city);
              const uniqueStops = [...new Set(stops)];
              if (uniqueStops.length === 1) {
                viaCity = ` (via ${uniqueStops[0]})`;
              } else if (uniqueStops.length === 2) {
                viaCity = ` (via ${uniqueStops.join(" & ")})`;
              } else if (uniqueStops.length > 2) {
                viaCity = ` (via ${uniqueStops.slice(0, -1).join(", ")} & ${uniqueStops.at(-1)})`;
              }
            }
            // Sum total time: flight durations + transit
            let totalMin = 0;
            for (let j = 0; j < journeyFlights.length; j++) {
              const durMatch = journeyFlights[j].duration.match(/(\d+)h\s?(\d+)m/);
              const flightMin = parseInt(durMatch[1]) * 60 + parseInt(durMatch[2]);
              totalMin += flightMin;
              // Add transit time if not last segment
              if (j < journeyFlights.length - 1) {
                const arr = new Date(`${journeyFlights[j].arrival.date}T${journeyFlights[j].arrival.time}`);
                const dep = new Date(`${journeyFlights[j + 1].departure.date}T${journeyFlights[j + 1].departure.time}`);
                const transitMin = Math.floor((dep - arr) / 60000);
                totalMin += transitMin;
              }
            }
            const h = Math.floor(totalMin / 60);
            const m = totalMin % 60;
            journeySummaries.push(`Flight ${journeySummaries.length + 1}: ${fromCity} → ${toCity}${viaCity} – ${h}h ${m}m`);
            journeyStartIndex = i + 1;
          }
        }
      }
      const journeySummaryText = journeySummaries.map(s => `<div>${s}</div>`).join("");

      const headerRow = `
        <tr>
          <th></th>
          <th>Date</th>
          <th>Airline</th>
          <th>Flight No</th>
          ${showCabin ? "<th>Cabin</th>" : ""}
          <th>Depart</th>
          <th>From</th>
          <th>Arrive</th>
          <th>At</th>
          <th>Duration</th>
          ${hasTransit ? "<th>Transit</th>" : ""}
        </tr>
      `;

      // Only show group label if there is more than one group
      const groupTitle = groups.length > 1 ? `<strong>${group.label}</strong><br>` : "";
      html += `
        <p>${groupTitle}</p>
        <table>
      `;

      // Insert journey separator rows
      let rows = "";
      group.flights.forEach((f, i) => {
        const logoIata = f.iataCode;
        const logo = getAirlineLogo(logoIata);
        const depDate = new Date(f.departure.date);
        const formattedDate = depDate.toLocaleDateString("en-GB", {
          weekday: "short", day: "numeric", month: "short"
        });
        // Only show the scheduled flight duration per row (do not add transit)
        const duration = f.duration;
        const cabinCell = showCabin ? `<td>${f.cabin || f.bookingClass}</td>` : "";

        const isNewJourney = (i === 0 || (() => {
          const prev = group.flights[i - 1];
          const prevArr = new Date(`${prev.arrival.date}T${prev.arrival.time}`);
          const thisDep = new Date(`${f.departure.date}T${f.departure.time}`);
          return (thisDep - prevArr) / 1000 / 60 / 60 >= 24;
        })());

        let journeyIndex = 0;
        let journeyCursor = 0;
        for (let j = 0; j < i; j++) {
          const prev = group.flights[j];
          const next = group.flights[j + 1];
          if (!next) break;
          const prevArr = new Date(`${prev.arrival.date}T${prev.arrival.time}`);
          const nextDep = new Date(`${next.departure.date}T${next.departure.time}`);
          if ((nextDep - prevArr) / 1000 / 60 / 60 >= 24) {
            journeyCursor++;
          }
        }
        journeyIndex = journeyCursor;

        let journeySummary = journeySummaries[journeyIndex];
        if (showSummaries && journeySummaries.length === 1) {
          journeySummary = journeySummary.replace(/^Flight 1: /, "");
        } else if (showSummaries && journeySummaries.length === 2) {
          const firstDepCity = group.flights[0].departure.city;
          const lastArrCity = group.flights[group.flights.length - 1].arrival.city;
          const splitIndexes = [];
          for (let i = 1; i < group.flights.length; i++) {
            const prevArr = new Date(`${group.flights[i - 1].arrival.date}T${group.flights[i - 1].arrival.time}`);
            const currDep = new Date(`${group.flights[i].departure.date}T${group.flights[i].departure.time}`);
            const diffHrs = (currDep - prevArr) / 1000 / 60 / 60;
            if (diffHrs >= 24) splitIndexes.push(i);
          }
          const secondDepCity = group.flights[splitIndexes[0]]?.departure.city;
          if (firstDepCity === lastArrCity || firstDepCity === secondDepCity) {
            if (journeyIndex === 0) {
              journeySummary = journeySummary.replace(/^Flight 1: /, "Outbound: ");
            } else if (journeyIndex === 1) {
              journeySummary = journeySummary.replace(/^Flight 2: /, "Inbound: ");
            }
          }
        }

        const headerRowSegmented = `
          <tr>
            <th></th>
            <th>Date</th>
            <th>Airline</th>
            <th>Flight No</th>
            ${showCabin ? "<th>Cabin</th>" : ""}
            <th>Depart</th>
            <th>From</th>
            <th>Arrive</th>
            <th>At</th>
            <th>Duration</th>
            ${hasTransit ? "<th>Transit</th>" : ""}
          </tr>
        `;
        // Always show header row for first flight, and for new journeys show summary if enabled
        const journeyHeader = ((isNewJourney && showSummaries) || i === 0)
          ? (showSummaries && isNewJourney
            ? `
                <tr>
                  <td colspan="${hasTransit ? 11 : 10}" style="font-weight:bold; border: none; background: none;">${journeySummary}</td>
                </tr>
                ${headerRowSegmented}
              `
            : headerRowSegmented)
          : "";

        rows += `
          ${journeyHeader}
          <tr>
            <td>${logo ? `<img src="${logo}" alt="${f.airline} logo">` : ""}</td>
            <td>${formattedDate}</td>
            <td>
              ${f.airline}
              ${f.operatedBy?.airlineName ? `<div style="font-size: 90%; color: #555;">Operated by ${f.operatedBy.airlineName}</div>` : ""}
            </td>
            <td>${f.flightNumber.replace(/[^\d]/g, "")}</td>
            ${cabinCell}
            <td>${formatTime(f.departure.time)}</td>
            <td>${f.departure.airportName} (${f.departure.airport})</td>
            <td>${formatTime(f.arrival.time)}</td>
            <td>${f.arrival.airportName} (${f.arrival.airport})</td>
            <td>${duration}</td>
            ${hasTransit ? `<td>${transitTimes[i] || ""}</td>` : ""}
          </tr>
        `;
      });

      html += rows + "</table>";
    });

    document.getElementById("flightTableWrapper").innerHTML = html;
    // Only show copy button if html contains a table (i.e., actual table content)
    if (html.includes("<table")) {
      document.getElementById("copyButton").style.display = "inline-block";
    } else {
      document.getElementById("copyButton").style.display = "none";
    }
  }

  function formatTime(time24) {
    const [hourStr, min] = time24.split(":");
    let hour = parseInt(hourStr);
    const ampm = hour >= 12 ? "pm" : "am";
    hour = hour % 12 || 12;
    return `${hour}:${min} ${ampm}`;
  }

  function copyTableToClipboard() {
    const copyBtn = document.getElementById("copyButton");
    copyBtn.classList.add("button-async--loading");
    // Set label to "Copied" and save original text
    const labelSpan = copyBtn.querySelector(".button-async__label");
    const originalText = labelSpan.textContent;
    labelSpan.textContent = "Copied";
    const wrapper = document.getElementById("flightTableWrapper");
    if (!wrapper) return;

    // Clone and apply light-mode styles
    const clone = wrapper.cloneNode(true);
    clone.querySelectorAll("table, th, td").forEach(el => {
      el.style.backgroundColor = "#fff";
      el.style.color = "#000";
      el.style.borderColor = "#333";
    });
    // Apply light-mode styles to all text elements (headings, paragraphs, etc)
    clone.querySelectorAll("*").forEach(el => {
      el.style.color = "#000";
      if (el.tagName.toLowerCase() === "p" || el.tagName.toLowerCase() === "h3") {
        el.style.backgroundColor = "#fff";
      }
    });

    // Explicitly set fixed dimensions for airline logos in copied table as inline style attribute (stricter for email compatibility)
    clone.querySelectorAll("td img").forEach(el => {
      el.removeAttribute("style");
      el.removeAttribute("height");
      el.setAttribute("width", "100");
      el.setAttribute("style", "display:inline-block; vertical-align:middle; object-fit:contain; max-height:50px;");
    });

    // Prepare hidden container
    const hiddenDiv = document.createElement("div");
    hiddenDiv.style.position = "fixed";
    hiddenDiv.style.top = "-9999px";
    hiddenDiv.appendChild(clone);
    document.body.appendChild(hiddenDiv);

    const range = document.createRange();
    range.selectNode(clone);
    const selection = window.getSelection();
    selection.removeAllRanges();
    selection.addRange(range);

    try {
      document.execCommand("copy");
    } catch (err) {
      console.error("Failed to copy table.", err);
    }

    selection.removeAllRanges();
    document.body.removeChild(hiddenDiv);
    setTimeout(() => {
      copyBtn.classList.remove("button-async--loading");
      labelSpan.textContent = originalText;
    }, 600);
  }

  function fetchFlightData() {
    const pnr = document.getElementById("pnrInput").value.trim();
    if (!pnr) {
      alert("Please enter a PNR.");
      return;
    }
    const submitBtn = document.getElementById("submitBtn");
    submitBtn.classList.add("button-async--loading");
    document.getElementById("flightTableWrapper").innerHTML = "";
    // Hide copy button before making fetch call
    document.getElementById("copyButton").style.display = "none";

    fetch("https://pnr-proxy.vercel.app/api/pnr", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6ImM1OTE5NjViLWI0N2QtNDM1MC1iNGNiLTdjODYyNTRmNDg1YiIsImlhdCI6MTc0NjQ4MjEwMH0.HGIbM8jp_uzA8vCBKvUXSPyTSbL-UTA_4k7rSG8gmzA"
      },
      body: JSON.stringify({ pnr })
    })
    .then(res => res.json())
    .then(data => {
      submitBtn.classList.remove("button-async--loading");
      if (!data || !data.data || !data.data.flights) {
        document.getElementById("flightTableWrapper").innerHTML = '<p style="color:red;">Invalid or incomplete PNR response.</p>';
        return;
      }
      renderFlightTable(data);
    })
    .catch(err => {
      submitBtn.classList.remove("button-async--loading");
      console.error("Error:", err);
      document.getElementById("flightTableWrapper").innerHTML = '<p style="color:red;">Unexpected Error:<br>Load failed</p>';
    });
  }
</script>

</body>
</html>
